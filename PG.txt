0) Purpose

Move from SAS + ad-hoc scripts + manual runs to Python → GitHub → CI/CD → Airflow on OpenShift (containers) with:

Built-in security, monitoring, data quality, auditability

Reproducible prod runs, fast rollback, and clear ownership

1) Ground Rules (non-negotiables)

Immutable runtime: Prod runs a pinned container image (tag@digest). No pip in prod.

Per-job images: Each job has its own thin image; all inherit from a shared base image.

Single approval gate: Promote image tag@digest Dev → UAT → Prod.

Secrets: Dev = personal ID; Prod = service ID + Vault (no secrets in code/images/logs).

Naming convention: lower_snake_case, ASCII, no spaces/special chars. Use views to map legacy names.

Data contract: Types, lengths, nullability, and keys are explicit. No silent truncation.

Airflow-only execution in Prod: manual or scheduled = same approved image.

2) Roles & RACI

Platform (OpenShift/Airflow): namespaces, quotas/SCC, registry access, observability.

Data Engineering (you): code, tests, DAGs, data contracts, runbooks, RCA.

DBA: staging/final schemas, performance, permissions, maintenance.

L1/L2 Support: monitor jobs, escalate with runbook.

Security/Compliance: approve image promotion, review SBOM/scan results.

3) Environments & Access

Dev / UAT / Prod namespaces in OpenShift.

GitHub: protected main branch; PR required.

Vault: prod secrets by service ID; short-lived tokens.

SQL Server: separate schemas for stg_raw, stg_valid, and final.

4) Developer Workflow (end-to-end)

Explore & prototype in Jupyter (Lumina).

Convert notebook → repo using the template (NBConvert Tool).

Generates repo skeleton, DAG metadata, PR.

CI (GitHub Actions/Helios)

Build base (periodic) and per-job images.

Tests (unit + parity), security & dependency scans, SBOM, sign image.

Push to registry with tag and digest.

Approval (UCD / GitHub Environments / Ansible Tower)

Single gate approves image tag@digest; records SBOM & scan results.

Airflow deployment

DAG syncs. KubernetesPodOperator runs the approved digest.

Run & observe

Logs in Airflow; alerts on failure/SLA breaches; audit row written.

Rollback

Set the previous digest in Airflow var; rerun.

5) Image Strategy

Base image: OS, Python, ODBC/SSL, base libs, CA certs. Versioned on a cadence.

Per-job image: minimal job code + deps (requirements-jobX.txt).

Policy: reject :latest, require signed images; store SBOM with the release.

6) Airflow Standards

Operator: KubernetesPodOperator with pinned image_digest.

Pre-run guard task (template in every DAG):

Check credentials/secret lease, network reachability, schema/partition existence, free disk.

Data promotion pattern:

Write to stg_raw → validate/clean into stg_valid → MERGE to final.

For S3 outputs: write to temp → manifest + READY marker → publish path.

Retry & SLA: set sensible retries/backoff; escalate after fixed time.

7) Data Modeling & Contracts

Naming: lower_snake_case, ≤64 chars, stable.

Types (key rules):

Currency/amounts: DECIMAL(19,4) (or (19,6) for fees/FX).

Rates/percents: DECIMAL(9,6).

IDs: VARCHAR/CHAR per source; avoid implicit casts.

Dates: DATE; times: DATETIME2(3); time zones documented.

Lengths (text):

Use observed p99 + headroom. Example: segments at 300; stg_raw may be wider (e.g., 400) to avoid landing truncation.

Staging vs Final:

stg_raw: mirrors source; len wider; nullable; capture raw anomalies.

stg_valid: conforms to final contract; enforced types/lengths.

final: governed schema; writes only via controlled merges.

Views for legacy names:
Map "Segment 8" → segment8, etc., via a compatibility view. Point Tableau/exports to the view while deprecating direct table use.

8) Audit & Observability

Audit table fields (per run):

dag_id, task_id, run_id, batch_id

image_tag, image_digest

row counts in/out, checksum/hash, duration, status, error summary

data window (e.g., snap_date), input partitions, output paths

Logs & alerts:

Stream pod logs to Airflow; alert on failure/SLA; daily summary optional.

9) Quality & Parity (SAS → Python)

Minimal DQ now (expand later):

Not-nulls on key cols; reference/lookup integrity; range checks; distinct counts.

SAS parity harness per job:

Row count match; key uniqueness; numeric diffs within tolerance; date/time equivalence; sorted output comparators; top-N sample diffs.

Store a parity report artifact per release.

10) Security

Secrets in Vault; rotate and lease-check in pre-run.

ServiceAccounts with least privilege; NetworkPolicies to DB/S3 only.

Admission: signed images only, no :latest, pinned digest.

No PII in labs/scratch; purge policies.

11) DBA Engagement (staging/final)

Ask/confirm:

Schemas: stg_raw, stg_valid, final (ownership, grants).

Retention: staging TTL (e.g., 30–90 days).

Indexing/partitioning for final (PK/clustered indexes).

Load windows and locking expectations.

Error handling: exceptions table + retry guidance.

12) Pivot/Validation Replacement (Autocomplete example)

Compute weekly aggregates in SQL/Python; persist to validation tables/views.

Share via Tableau (pre-prod project) with threshold highlights.

Notify via subscriptions or data-driven alerts—no manual Excel pivots.

If Excel is temporarily needed, generate from Python as a controlled artifact, not manual edits.

13) Runbooks (must exist for each job)

Trigger & parameters (manual + scheduled).

Expected inputs/outputs; pre-run/data window checks.

Common failures and exact remediation steps.

Rollback: where to set previous image_digest, how to rerun.

Contacts & escalation.

14) Change Management

PR with tests + parity report deltas.

CI artifacts: SBOM, scan results, image digest.

Approval ticket: attach artifacts, risk note, rollback tag.

Post-deploy verification checklist (10 minutes).

15) Risks & Mitigations

Env drift: pinned digest; immutable images; admission policy.

Upstream schema drift: pre-run schema checks; quarantine to exceptions.

Cred/cert expiry: Vault rotation; expiry alarms.

Small-files / performance: target Parquet size 128–512 MB; coalesce.

Runtime downloads (if forced): versioned S3 paths + checksum verify; log URI + SHA.
